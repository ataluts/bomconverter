# BoM Converter

## Назначение
***RU***: Автоматизированное создание перечня элементов (ПЭ3), списка закупки компонентов (СК) и спецификации (СП) из проекта Altium Designer.<br/>
***EN***: Automated creation of components database from Altium Designer projects, schematics, and BoM files with export to various formats.

## Описание
Программа извлекает информацию о проекте Altium Designer и о компонентах из его BoM-файлов. Затем сводит эту информацию в стандартизованную базу данных и уже из этой базы экспортирует данные в требуемый тип документа с требуемым форматированием. Проект сделан модульно чтобы импорт, анализ, сборка и экспорт были максимально независимы друг от друга. Это позволяет каждому схемотехнику написать свой анализатор под свой формат ведения схемы и проекта. При этом экспорт задаётся принятым на предприятии стандартом и может сопровождаться соответствующими сотрудниками без участия схемотехника.

### Краткое описание работы
Центральным элементом работы программы является база данных компонентов. Ключевым моментом является её наполнение, и тут возможны варианты: можно давать программе либо файл проекта в котором все данные подвязаны (что предпочтительно), либо BoM-файлы и данные основной надписи по отдельности.

В случае работы с проектом AD достаточно указать только адрес самого файла. Программа запускает импортёр проекта AD, который берёт на себя все технические сложности чтения проекта и составляет из него соответсвующий объект. Далее созданный объект проекта передаётся в анализатор конкретного схемотехника, который знает как правильно достать данные из проекта и выдаёт список BoM-файлов вместе с данными "основной надписи". (Особенность конкретно моего анализатора проекта заключается в том, что BoM файлы должны быть добавлены в проект, быть с расширением *"csv"* и иметь префикс *"bom"*, а именем конфигурации считается весь текст между *"BoM "* и *".csv"*).

Далее обрабатывается каждый BoM-файл из полученного списка. Вначале импортёр открывает BoM-файл и составляет из него соответствующий объект. Затем этот объект передаётся в анализатор схемотехника, который знает как из представленных данных правильно сформировать базу данных компонентов (попутно проверив всё на возможные ошибки). (Особенность конкретно моего парсера BoM заключается в том, что при экспорте из AD не должно быть группировки компонентов - то есть каждый компонент должен находится в отдельной строке).

После наполнения базы данных компонентов выполняются доступные оптимизации данных (например имён производителей и точности резисторов).

Далее для каждого типа экспорта соответствующим модулем происходит сборка соответсвующего объекта, после чего этот объект передаётся в требуемый экспортёр который производит запись данных в нужный формат.

В отдельный модуль выделена сборка значений (по ЕСКД или по любому-другому формату) которая собирает поля из параметров компонентов в базе данных. Стиль форматирования при сборке строки передаётся в качестве параметров при вызове функции и также доступен при вызове сборщика. 

Все настройки программы сведены в единый словарь находящийся в отдельном модуле, который можно изменить при запуске программы соответствующим аргументом. Также имеется возможность локализации, словарь которой также задаётся в отдельном модуле. Группировка элементов в перечне происходит по префиксу в позиционном обозначении. Имена групп задаются в отдельном словаре для соответствующего сборщика. Сам словарь может быть передан в сборщик в качестве параметра.

## Как пользоваться
### Способы запуска
- запускать `bomconverter.py` из командной строки с указанием параметров (*-h* для их описания), либо просто перетащив на него файлы в проводнике (но тогда все параметры будут в значениях по-умолчанию);
- запуск из IDE через файл `_launcher.py` в котором задать все нужные параметры и список всех проектов (имхо, самый удобный вариант);
- использовать как модуль и вызывать соответствующие функции: `process_adproject()` или `process_bom()`;
- использовать графический интерфейс пользователя `gui.py`.

### Параметры запуска из командной строки
`bomconverter.py файл_данных [файл_данных ...] [опции ...]`

**Опции:**
| &nbsp;&nbsp;&nbsp;Параметр&nbsp;&nbsp;&nbsp; | Данные | Значение по-умолчанию  | Описание |
| --------------- | :----: | :--------------------: | -------- |
| `--adproject`   | `none` | `False`                | Флаг указывающий что передан файл проекта Altium Designer. Программа сама выставляет его если расширение файла `PrjPcb`. |
| `--titleblock`  | `file` | `None`                 | Адрес модуля с данными основной надписи. Сами данные должны быть внутри модуля в словаре с именем `data`. |
| `--output-dir`  | `<dir>`| *как у входных файлов* | Адрес папки куда будут записаны выходные файлы. |
| `--parser`      | `file` | `parse_taluts.py`      | Адрес модуля анализатора преобразующего данные из проекта AD и BoM-файлов в базу данных. |
| `--settings`    | `file` | `dict_settings.py`     | Адрес модуля со всеми настройками программы. Сами настройки должны быть внутри модуля в словаре с именем `data`. |
| `--output`      | `list` |                        | Список выходных файлов (что и в каком формате надо получить). Варианты указываются через пробел. |
| `--optimize`    | `list` |                        | Список оптимизаций которые проводить над базой данных. Варианты указываются через пробел. |
| `--noquestions` | `none` | `False`                | Не задавать вопросов по ходу выполнения (например какие BoM файлы выбрать из проекта). |
| `--nohalt`      | `none` | `False`                | Не останавливать программу перед её завершением. |
| `--debug`       | `none` | `False`                | Режим отладки. Ошибки не скрываются, а обрабатываются средой разработки. |



**Выходные форматы** (*--output*):
|  Название  | Описание |
| :--------: | -------- | 
| `all`      | Экспорт всего возможного. |
| `cl-xlsx`  | Список компонентов для закупки с группировкой по номиналам и отдельным листом со списком допустимых замен (если присутствуют) в формате MS Excel; |
| `pe3-docx` | Перечень элементов (ПЭ3) в формате MS Word. |
| `pe3-pdf`  | Перечень элементов (ПЭ3) в формате PDF (должен быть установлен MiKTeX). |
| `pe3-csv`  | Перечень элементов (ПЭ3) в формате CSV. |
| `sp-csv`   | "Спецификация" - файл для импорта данных (с полями заполненными как для ПЭ3) в *"КОМПАС-3D"* через прикладную библиотеку *"Конвертор eCAD-КОМПАС (текст)"*. |
| `none`     | Ничего не экспортировать. |

Если параметр не задан при вызове программы, то берётся значение из файла настроек. Если в настройках значение не указано то берётся значение по-умолчанию, эквивалентное `all`.



**Оптимизаторы данных** (*--optimize*):
|  Название  | Описание |
| :--------: | -------- | 
| `all`      | Оптимизация всего возможного. |
| `mfr-name` | Трансляция имён производителей по словарю, которая позволяет привести разные вариации записи имён к единообразию. |
| `res-tol`  | Замена резисторов с 5% допуском на аналогичные 1%, если такие уже присутствуют среди компонентов. |
| `none`     | Ничего не оптимизировать. |

Если параметр не задан при вызове программы, то берётся значение из файла настроек. Если в настройках значение не указано то берётся значение по-умолчанию, эквивалентное `none`.

### Зависимости
**_import_adproject.py_**
- [olefile](https://pypi.org/project/olefile) - `pip install olefile`

**_export_cl_xlsx.py_**
- [XlsxWriter](https://xlsxwriter.readthedocs.io/) - `pip install xlsxwriter`

**_export-pe3_docx.py_**
- [python-docx](https://python-docx.readthedocs.io) - `pip install python-docx`
- [Pillow](https://pillow.readthedocs.io) - `pip install Pillow`

**_export_pe3_pdf.py_**
- [MiKTeX](https://miktex.org/)

**_gui.py_**
- [wxPython](https://www.wxpython.org/) - `pip install -U wxPython`

## Примеры
В папке `example/AD project` находится тестовый проект Altium Designer сделанный для работы с моим анализатором (его адрес добавлен в `_launcher.py`). На схеме представлены различные элементы с примерами заполнения полей. BoM-файлы проекта экспортируются в папку `example/AD project/project outputs/Bill of Materials`. Туда же записываются и выходные файлы самой программы. Все эти файлы доступны там в качестве примера получаемого результата.

Подробное описание формата параметров компонентов для моего анализатора приведено в файле `example/AD component parameters formatting.docx`

## Disclaimer
Программа разрабатывалась в перерывах между основной работой (а именно разработкой оборудования - я схемотехник, а не программист) и как первый проект на Python, поэтому не ждите вылизанного кода, правильного синтаксиса и нормальной обработки ошибок. Хотя, справедливости ради, следует заметить, что код полностью переписывался с нуля уже 2 раза и это третья итерация данного программного решения. Ну и, конечно, при таком раскладе не реализовано довольно много всего, особенно в плане отработки параметров в цепочке анализатор-БД-сборщик.

Изначальная идея была взята из скрипта [Bombier 2.0](https://github.com/dngulin/bombier) с принципиальной разницей в прогоне компонентов через базу данных, чтобы отвязать форматирование параметров в проекте Альтиума от форматирования параметров в перечне элементов. 
